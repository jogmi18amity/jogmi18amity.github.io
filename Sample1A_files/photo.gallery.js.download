/*! updated; 04-10-2018 03:45 PM **/


Modulr.define("core.components:modal/modules/photo.gallery",["require","jquery","lodash","core.templates:api","core.base:utils/environment","core.base:utils/detector"],function(require,$,_){return function(props){function render(items,active,index){if(target)index=index||0,target.addClass("show"),target.find("li#slide-"+index).addClass("show");else{var html=TEMPLATE_MARKUP({articles:items});$("#wrapper").prepend(html),target=$("#wrapper > .popup-modal:first")}$("body").addClass("scroll-lock");var content=target.find(".content"),modal_arrows_next=target.find(".page-arrows .next"),modal_arrows_prev=target.find(".page-arrows .prev");"1"!==target.attr("data-init")&&(target.attr("data-init","1"),modal_arrows_next.on("click",function(evt){evt.preventDefault();var current=content.find("li.show");current.next().length>0?(current.next().addClass("show"),current.removeClass("show")):(content.find("li:first").addClass("show"),current.removeClass("show"))}),modal_arrows_prev.on("click",function(evt){evt.preventDefault();var current=content.find("li.show");current.prev().length>0?(current.prev().addClass("show"),current.removeClass("show")):(content.find("li:last").addClass("show"),current.removeClass("show"))}),target.find("a.close").on("click",function(evt){return evt.preventDefault(),Proto.close(active),!1}),content.hover(function(){HOVER_OVER=!0},function(){HOVER_OVER=!1}),$("html, body").on("click",function(){target&&target.hasClass("show")&&!HOVER_OVER&&Proto.close(active)}),$(document).keyup(function(evt){27===evt.keyCode&&Proto.close(active)}))}function triggerCallback(event,data){if(EVENT_CALLBACK[event])for(var i=0,evt=EVENT_CALLBACK[event];i<evt.length;i++)evt[i](data)}var container,Environment=require("core.base:utils/environment"),Detector=require("core.base:utils/detector"),mainGallery=$("main .collection-gallery"),railGallery=$(".sidebar .collection-gallery"),Template=($(".collection-gallery"),require("core.templates:api")),view=Detector.current(),articles=[],Proto=this,target=null,TEMPLATE_MARKUP=!1,HOVER_OVER=!1,EVENT_CALLBACK={};Proto.set=function(){if(Environment.isProd()||Environment.isStaging())return!1;mainGallery.length>0&&Proto.gallery(),railGallery.length>0&&Proto.railGallery()},Proto.close=function(active){target&&(target.removeClass("show"),target.find("li.show").removeClass("show"),active&&active.removeClass("active"),$("body").removeClass("scroll-lock"),triggerCallback("close"))},Proto.railGallery=function(){function setCount(init,dir){init?(first=1,last=images.length<9?images.length:9):"next"===dir?last+9<=images.length?(first+=last,last+=9):(add=images.length-last,first=last+1,last+=add):"prev"===dir&&(0!==add?(first-=9,last-=add,add=0):(first-=9,last-=9)),count.html("Showing <span>"+first+"-"+last+"<span> of <span>"+images.length+"</span>")}var scroll,holder=railGallery.find(".scroll-outer"),count=railGallery.find(".count"),images=[],current=0,first=0,last=0,add=0;if(images=holder.find("article"),images.each(function(){$(this).removeClass("hide").addClass("show")}),setCount(!0),!(images.length<=9)){var row_ht=Math.floor(images.first().outerHeight(!0)),total_viewable_ht=3*row_ht,total_rows=Math.ceil(images.length/3),total_items_ht=row_ht*total_rows;scroll=total_viewable_ht<=total_items_ht-total_viewable_ht?total_viewable_ht:total_items_ht-total_viewable_ht,holder.height(total_viewable_ht);var btns=holder.siblings(".page-arrows"),prev_btn=btns.find(".prev"),next_btn=btns.find(".next");images.length>9&&next_btn.addClass("show"),next_btn.on("click",function(evt){evt.preventDefault(),current=holder.scrollTop(),holder.scrollTop(current+scroll),current+=scroll,current+scroll>=total_items_ht&&next_btn.removeClass("show"),prev_btn.addClass("show"),setCount(!1,"next")}),prev_btn.on("click",function(evt){evt.preventDefault(),holder.scrollTop(current-scroll),current-=scroll,0===current&&prev_btn.removeClass("show"),next_btn.addClass("show"),setCount(!1,"prev")}),images.on("click",function(evt){if("mobile"!==view){evt.preventDefault();var elem=$(this),active=elem.addClass("active"),index=images.index($(this));Proto.popup(images,active,index)}})}},Proto.gallery=function(){mainGallery.length>0&&(container=mainGallery.find(".scroll-outer")),articles=container.find("article"),articles.each(function(){$(this).removeClass("hide").addClass("show")});var arrows=container.siblings(".page-arrows"),prev_button=arrows.find(".prev"),next_button=arrows.find(".next"),container_width=container.width(),first_article_width=articles.length>0?$(articles).first().outerWidth(!0):0,middle_article_width=articles.length>2?$(articles[1]).outerWidth(!0):0,last_article_width=articles.length>1?$(articles).last().outerWidth(!0)-12:0,total_articles_width=first_article_width;total_articles_width+=middle_article_width*(articles.length-2),total_articles_width+=last_article_width;var scroll_width=Math.round(total_articles_width/(articles.length/5)),currentScroll=!1;articles.length>0&&total_articles_width>container_width&&next_button.addClass("show"),0===container.scrollLeft()&&prev_button.removeClass("show"),container.find(".scroll-inner").width(total_articles_width+24),$(container).scroll(_.throttle(function(){currentScroll=container.scrollLeft(),0===currentScroll?prev_button.removeClass("show"):prev_button.addClass("show"),currentScroll>=Math.floor(total_articles_width-container_width-10)?next_button.removeClass("show"):next_button.addClass("show")},500)),$(window).resize(_.throttle(function(){container_width=container.width(),scroll_width=Math.round(total_articles_width/(articles.length/5)),total_articles_width<=container_width?(prev_button.removeClass("show"),next_button.removeClass("show")):next_button.addClass("show")},500)),prev_button.find("a").on("click",function(evt){evt.preventDefault();var target_scroll=container.scrollLeft()-scroll_width;target_scroll<=0&&(target_scroll=0),container.animate({scrollLeft:target_scroll},500,function(){0===container.scrollLeft()&&prev_button.removeClass("show")})}),next_button.find("a").on("click",function(evt){evt.preventDefault();var target_scroll=container.scrollLeft()+scroll_width;target_scroll>total_articles_width-container_width&&(target_scroll=total_articles_width-container_width),container.animate({scrollLeft:target_scroll},500,function(){(container.scrollLeft()<target_scroll||container.scrollLeft()>=Math.floor(total_articles_width-container_width-10))&&next_button.removeClass("show")})}),articles.on("click",function(evt){if("mobile"!==view){evt.preventDefault();var elem=$(this),active=elem.addClass("active"),index=articles.index($(this));Proto.popup(articles,active,index)}})},Proto.popup=function(items,elem,index){Template.get("/static/orion/scripts/core/components/app/modal/templates/photo.html",function(html){TEMPLATE_MARKUP=_.template(html),render(items,elem,index)})}}});